{
  "sub_form": {
    "section": [
      {
        "name": "作业参数",
        "field": [
          {
            "id": "JOB_NAME",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "作业名称",
            "help": "作业名称只允许字符：字母，数字, 下划线和中划线",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": true,
            "type": "text",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "1",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "test",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "text",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true
          }
        ]
      },
      {
        "name": "集群参数",
        "field": [
          {
            "id": "NUM_CPU",
            "action": "",
            "default_value": "4",
            "default_values": [],
            "hidden": false,
            "label": "使用CPU核数",
            "help": "",
            "options": ["1", "2", "4", "8", "16", "32"],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "list",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "TIME_STEP",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "非定常时间步长",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "text",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "DUAL_TIME_STEP",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "非定常时间步数",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "text",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "ITERATION",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "迭代次数",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": true,
            "type": "text",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "QUEUE",
            "action": "$CONFDIR/application/script/queue.sh",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "作业提交队列",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "list",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "CONSOLE_SUPPORT",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "图形作业",
            "help": "",
            "options": ["yes", "no"],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "list",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "RELEASE",
            "action": "",
            "default_value": "17.0",
            "default_values": [],
            "hidden": false,
            "label": "软件版本",
            "help": "",
            "options": ["17.0", "18.0", "19.2.0"],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "list",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "VERSION",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "版本",
            "help": "",
            "options": ["2d", "3d"],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "list",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "OTHER_SCHEDULER_PARAMS",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "调度器其它参数",
            "help": "指定调度器的其它参数. 每一项参数用分号(;)隔开. 例如: -N jobname;-r y",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "text",
            "value": "",
            "values": [],
            "file_from_type": "",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          }
        ]
      },
      {
        "name": "作业数据",
        "field": [
          {
            "id": "RESULT_NAME",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "计算结果名",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "lsfile",
            "value": "",
            "values": [],
            "file_from_type": "local_server",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "CAS_INPUT_FILE",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "输入文件 (.cas)",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": true,
            "type": "lsfile",
            "value": "",
            "values": [],
            "file_from_type": "local_server",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "DAT_INPUT_FILE",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "输入文件 (.dat)",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "lsfile",
            "value": "",
            "values": [],
            "file_from_type": "local_server",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          },
          {
            "id": "OTHER_INPUT_FILE",
            "action": "",
            "default_value": "",
            "default_values": [],
            "hidden": false,
            "label": "其他输入文件",
            "help": "",
            "options": [],
            "options_from": "custom",
            "options_script": "",
            "post_text": "",
            "required": false,
            "type": "lsfile",
            "value": "",
            "values": [],
            "file_from_type": "local_server",
            "is_master_slave": false,
            "master_slave": "",
            "master_include_extensions": "",
            "master_include_keywords": "",
            "custom_json_value_string": "{}",
            "is_support_master": true,
            "master_file": "",
            "is_support_workdir": false,
            "workdir": ""
          }
        ]
      }
    ]
  },
  "desc": "提交一个Fluent作业",
  "help_doc": { "type": "url", "value": "" },
  "state": "unpublished",
  "last_modified_time": 1681895505,
  "name": "Fluent",
  "app_id": "4PXsRSf2SDf",
  "script": "# Source COMMON shell functions\n. ${CONFDIR}/application/script/common.sh\n\n# Get Job Name and Job Path\nNAME_STR=`getJobNameAndIndex \"${JOB_NAME//\\ /_}\"`\nJOB_NAME=`echo $NAME_STR | awk '{print $1}'`\nJOB_INDEX=`echo $NAME_STR | awk '{print $2}'`\n\npbs_name=$JOB_NAME\nif [ \"x$JOB_INDEX\" != \"x\" ]; then\n    pbs_index=\" -J $JOB_INDEX\"\nfi\n\nif [[ \"x${JOB_FILE_DIRECTORY}\" != \"x\" ]] ; then\n    JOB_FILE_DIRECTORY=`delQuoteFromPath ${JOB_FILE_DIRECTORY}`\nelse\n    JOB_FILE_DIRECTORY=`pwd`\nfi\nCURRENT_WORK_DIR=$JOB_FILE_DIRECTORY\n\nnum_nodes=1\nif [ \"x$NUM_NODE\" != \"x\" ]; then\n    num_nodes=$NUM_NODE\nfi\nnum_cores=$NUM_CPU\nqueue=$QUEUE\n\nif [[ \"x${PSP_JOB_APP_ENV}\" != \"x\" ]] ; then\n    env_opt=\"-v ${PSP_JOB_APP_ENV}\"\nfi\n\nif [ \"x$JOUR_FILE\" == \"x\" ]; then\n    CURRENT_WORK_DIR=$JOB_FILE_DIRECTORY\n    export JOUR_FILE=\"journal_$$\"\n    export FLUENT_JOURNAL=\"$CURRENT_WORK_DIR/$JOUR_FILE\" CAS_INPUT_FILE\n    sh ${CONFDIR}/application/script/create_journal.sh & > /dev/null 2>&1\n    exit_code=$?\n    if [ ! $exit_code -eq 0 ]; then\n        rm -f \"$FLUENT_JOURNAL\"\n        echo \"Faild to create journal file.\" 1>&2\n        exit $exit_code\n    fi\nfi\n\nexport JOUR_FILE=${JOUR_FILE##*/}\n \n# Create PBS Script\nPBS_SCRIPT=${CURRENT_WORK_DIR}/.submit.qsub\n(cat <<\"EOF\"\n#!/bin/bash\n\n# 0. Computing Parameters\ncd ${PBS_O_WORKDIR}\nfile_name={{main_file}}\nversion={{f_version}}\nnum_cores=`cat $PBS_NODEFILE | wc -l`\n#num_nodes=`cat $PBS_NODEFILE | uniq | wc -l`\ncat $PBS_NODEFILE > ./hostlist\n\n# 1. Select Solver Version\nappname=ANSYS_v202\nzip_path=/home/apps_store/apks/$appname\ntarget_path=/home/apps_store/apps/$appname\nconfig_path=/opt/yuansuan/psp/config/application/job_submission/$appname\nfluent=$target_path/ansys_inc/v202/fluent/bin/fluent\n\n# 2. Run Fluent\ntouch out.log\nulimit -l unlimited\nexport I_MPI_NETMASK=172.31.254.0/24\nDISPLAY={{display}}\nexport DISPLAY\n$fluent -g 3ddp -t$num_cores -cnf=./hostlist -ssh -mpi=ibmmpi -i $file_name> out.log 2>&1\necho \"The ANSYS_Fluent calculation is complete\" >> out.log\nEOF\n) >> $PBS_SCRIPT\nsed -i \"s/{{main_file}}/$JOUR_FILE/g\" $PBS_SCRIPT\n\n# if open graphic config shell\nWORK_TOP=/opt/yuansuan/psp/work\nVNC_SCRIPT_DIR=\"${CONFDIR}/application/script/vnc\"\nVNC_WIDTH=1920\nVNC_HEIGHT=1080\nREMOTE_EXEC=\"ssh -t\"\nVNC_TYPE=novnc\n\nif [ $VERSION == \"3d\" ]; then\n    sed -i \"s:3ddp:-r20.2.0 3d:\" $PBS_SCRIPT\nelse\n    sed -i \"s:3ddp:-r20.2.0 2d:\" $PBS_SCRIPT\nfi\n\nif [ \"X$VNCServer\" == \"X\" ]; then\n    HOSTNAME=`hostname`\n    VNCServer=$HOSTNAME\nfi\n\nif [ \"$CONSOLE_SUPPORT\" = \"yes\" ]; then\n    export VNC_TYPE=$VNC_TYPE REMOTE_EXEC=$REMOTE_EXEC VNC_SCRIPT_DIR=$VNC_SCRIPT_DIR WORK_TOP=$WORK_TOP\n    export PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/opt/pbs/bin\n    VNC_ID=`${VNC_SCRIPT_DIR}/start_vnc.sh ${CURRENT_WORK_DIR} ${USER} ${VNC_WIDTH} ${VNC_HEIGHT}`\n    sleep 2\n    DISPLAY=\"${VNCServer}:${VNC_ID}.0\"\n    sed -i \"s/{{display}}/$DISPLAY/g\" $PBS_SCRIPT\n    sed -i \"s:-g::\" $PBS_SCRIPT\nfi\n\n# 3. submit job\nJOB_RESULT=`/bin/sh -c \"cd $CURRENT_WORK_DIR;qsub -N $pbs_name $pbs_index -W sandbox=PRIVATE -q $queue $env_opt -l nodes=$num_nodes:ppn=$num_cores $PBS_SCRIPT\"`\necho $VNC_ID >> $CURRENT_WORK_DIR/vnc.txt\nexport JOB_RESULT JOB_FILE_DIRECTORY VNC_ID\n${CONFDIR}/application/script/job.sh\n",
  "cloud_target": false,
  "ttl": 90,
  "is_internal": true
}
